name: Deploy-Cybera

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy deploy script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CYBERA_HOST }}
          username: ${{ secrets.CYBERA_USERNAME }}
          key: ${{ secrets.CYBERA_RSA }}
          port: 22
          source: update-cybersec-app.sh
          target: /home/${{ secrets.CYBERA_USERNAME }}/

      - name: Copy nginx config to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.CYBERA_HOST }}
          username: ${{ secrets.CYBERA_USERNAME }}
          key: ${{ secrets.CYBERA_RSA }}
          port: 22
          source: infra/nginx/cybersec-ucalgary.club.conf
          target: /home/ubuntu/

      - name: Enable nginx site and run deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CYBERA_HOST }}
          username: ${{ secrets.CYBERA_USERNAME }}
          key: ${{ secrets.CYBERA_RSA }}
          port: 22
          script: |
            set -euo pipefail

            CONF_NAME="cybersec-ucalgary.club.conf"
            SRC="/home/ubuntu/infra/nginx/${CONF_NAME}"
            DEST="/etc/nginx/sites-available/${CONF_NAME}"
            LINK="/etc/nginx/sites-enabled/${CONF_NAME}"

            echo "[+] Installing nginx config..."
            sudo mkdir -p /etc/nginx/sites-available
            sudo cp "$SRC" "$DEST"
            sudo chown root:root "$DEST"

            echo "[+] Enabling site..."
            sudo ln -sf "$DEST" "$LINK"

            if [ -e /etc/nginx/sites-enabled/default ]; then
              echo "[+] Disabling default nginx site..."
              sudo rm -f /etc/nginx/sites-enabled/default
            fi

            echo "[+] Testing nginx config..."
            sudo nginx -t

            echo "[+] Reloading nginx..."
            sudo systemctl reload nginx

            echo "[+] Running deploy script..."
            chmod +x /home/ubuntu/update-cybersec-app.sh
            /home/ubuntu/update-cybersec-app.sh
